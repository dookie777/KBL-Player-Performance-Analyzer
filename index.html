<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <meta charset="UTF-8">
  <title>23-24 KBL Player Stats Analyzer</title>
  <style>
body {
  background: linear-gradient(135deg, rgba(18,18,18,0.9) 30%, rgba(37,37,37,0.9) 100%);
  background-image: radial-gradient(rgba(42,42,42,0.6) 0.5px, transparent 0.5px), radial-gradient(rgba(42,42,42,0.6) 0.5px, transparent 0.5px);
  background-size: 20px 20px;
  background-position: 0 0, 10px 10px;
  color: #FFF;
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
  overflow: hidden;
}
/* ✅ 좌우 스크롤 시 1,2열 제목 고정 완벽 복구 */
#tab-all table {
  position: relative;
}

#tab-all th:nth-child(1),
#tab-all td:nth-child(1),
#tab-all th:nth-child(2),
#tab-all td:nth-child(2) {
  position: sticky;
  background-color: #282828 !important;
  z-index: 10;
}

#tab-all th:nth-child(1),
#tab-all td:nth-child(1) {
  left: 0;
  z-index: 11; /* 이름 열이 최우선으로 보이게 설정 */
}

#tab-all th:nth-child(2),
#tab-all td:nth-child(2) {
  left: 150px;
  z-index: 10; /* 팀 열이 이름 열 다음으로 보이게 설정 */
}

/* 스크롤 시 헤더 열 (상단) 고정 */
#tab-all thead th {
  position: sticky;
  top: 0;
  background-color: #282828 !important;
  z-index: 12; /* 열 제목이 가장 위에 오도록 설정 */
}

.container {
  max-width: 1200px;
  margin: auto;
  padding: 20px;
  box-sizing: border-box;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

h2 {
  text-align: center;
  color: #FFA500;
}

.tabs {
  text-align: center;
  margin-bottom: 15px;
}

.tabs button {
  background: #282828;
  color: #FFF;
  padding: 10px 20px;
  border: none;
  cursor: pointer;
  margin: 0 5px;
  font-weight: bold;
  width: 160px;
}

.tabs button.active {
  background: #E0E0E0;
  color: #000;
}

.tab-content {
  display: none !important;
  flex-direction: column;
  flex: 1;
  overflow: hidden !important;
}

.tab-content.active {
  display: flex !important;
}

.input-box {
  display: flex;
  justify-content: center;
  align-items: center;
  flex-wrap: wrap;
  margin-bottom: 20px;
}

.input-box input[type="text"],
.input-box button {
  height: 42px !important; /* 정확히 버튼 높이와 동일하게 고정 */
  padding: 5px 15px;
  font-size: 0.9rem;
  border-radius: 5px;
  border: none;
  margin: 5px;
  box-sizing: border-box; /* padding과 border가 height에 포함되도록 설정 */
}


.input-box input[type="text"] {
  width: 250px;
  font-size: 1rem;
}

.input-box button {
  background-color: #88c2dd;
  color: #121212;
  cursor: pointer;
  font-weight: bold;
}

.input-box input[type="checkbox"] {
  margin: 0 5px;
}

.input-box label {
  color: #FFF;
  font-size: 0.9rem;
  cursor: pointer;
  user-select: none;
}

.scroll-container, .stats-container, .compare-result {
  flex: 1;
  overflow: auto;
}

.scroll-container::-webkit-scrollbar,
.stats-container::-webkit-scrollbar,
.compare-result::-webkit-scrollbar {
  width: 10px;
  height: 10px;
}

.scroll-container::-webkit-scrollbar-track,
.stats-container::-webkit-scrollbar-track,
.compare-result::-webkit-scrollbar-track {
  background: #121212;
  border-radius: 5px;
}

.scroll-container::-webkit-scrollbar-thumb,
.stats-container::-webkit-scrollbar-thumb,
.compare-result::-webkit-scrollbar-thumb {
  background: #555;
  border-radius: 5px;
  border: 2px solid #121212;
}

.scroll-container::-webkit-scrollbar-thumb:hover,
.stats-container::-webkit-scrollbar-thumb:hover,
.compare-result::-webkit-scrollbar-thumb:hover {
  background: #FFA500;
}

table {
  border-collapse: collapse;
  white-space: nowrap;
  width: max-content;
}

th, td {
  padding: 8px;
  border-bottom: 1px solid #333;
  font-size: 0.85rem;
  text-align: center;
  background: #181818;
  font-weight: bold;
}

thead th {
  background: #282828;
  position: sticky;
  top: 0;
  cursor: pointer;
  z-index: 500;
}

#tab-all th:nth-child(1), #tab-all td:nth-child(1),
#tab-all th:nth-child(2), #tab-all td:nth-child(2) {
  position: sticky;
  background-color: #282828 !important;
  z-index: 400;
}

#tab-all th:nth-child(1), #tab-all td:nth-child(1) {
  left: 0;
}

#tab-all th:nth-child(2), #tab-all td:nth-child(2) {
  left: 150px;
}

.highlight { 
  color: #FFFF55 !important; 
  font-weight: bold; 
}

.player-name {
  font-size: 2rem;
  font-weight: bold;
  margin: 15px 0 5px;
  text-align: center;
}

.team-name {
  font-size: 1rem;
  text-align: center;
  margin-bottom: 15px;
}

.stats-container {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 15px;
  margin-top: 20px;
  padding-bottom: 60px;
}

.card {
  background-color: rgba(255,255,255,0.05);
  padding: 10px;
  border-radius: 10px;
  text-align: center;
  min-height: 350px;
}

.card.primary:nth-child(2) { min-height: 420px; }
.card.primary h3 { color: #FFA500; }
.card.secondary h3 { color: #88c2dd; }

.card h3 {
  margin: 0 0 8px;
  font-size: 1.1rem;
}

.card table {
  width: 100%;
}

.card th, .card td {
  padding: 8px 5px;
  border-bottom: 1px solid rgba(255,255,255,0.2);
}

.card.team-stats {
  min-height: 380px !important;
}

.card.team-stats h3 {
  color: #88c2dd !important;
}

#tab-compare .compare-result {
  max-width: none !important;
  height: calc(100vh - 260px);
  padding: 15px;
  margin: 0 auto;
}

#tab-compare .compare-result table {
  table-layout: auto !important;
  transform: none !important;
}

#tab-compare .compare-result th,
#tab-compare .compare-result td {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding: 10px 15px !important;
  font-size: 0.85rem !important;
}

#tab-compare .compare-result th {
  background-color: #282828 !important;
  padding: 15px !important;
}

.highlight-first {
  background-color: rgba(255,140,0,0.95) !important;
  color: #FFF !important;
}

.highlight-second {
  background-color: rgba(70,150,200,0.95) !important;
  color: #FFF !important;
}

.highlight-third {
  background-color: rgba(160,160,160,0.95) !important;
  color: #FFF !important;
}

.footer {
  text-align: center;
  padding: 10px;
  font-size: 0.8rem;
  color: #888;
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background-color: #000;
  pointer-events: none;
}
/* ✅ 1페이지 헤더 완벽 고정 (긴급 해결 재적용) */
#tab-all th:nth-child(1),
#tab-all th:nth-child(2) {
  position: sticky;
  top: 0 !important;
  background-color: #282828 !important;
  z-index: 500 !important;
}

#tab-all td:nth-child(1),
#tab-all td:nth-child(2) {
  position: sticky;
  left: 0;
  background-color: #282828 !important;
  z-index: 400 !important;
}

#tab-all th:nth-child(2),
#tab-all td:nth-child(2) {
  left: 150px;
}

/* ✅ 선수 개인 검색 페이지 간격 축소 (중요 수정) */
#tab-player .input-box {
  margin-bottom: 10px !important; /* 기존 20px → 절반으로 수정 */
}

#tab-player .player-name {
  margin: 8px 0 3px 0 !important; /* 기존 15px, 5px → 절반으로 수정 */
}

#tab-player .team-name {
  margin-bottom: 8px !important; /* 기존 15px → 절반으로 수정 */
}

#tab-player .stats-container {
  margin-top: 10px !important; /* 기존 20px → 절반으로 수정 */
}

/* ✅ 선수 비교 페이지 입력창 크기 및 영역 최적화 (중요 수정) */
#tab-compare .input-box input[type="text"] {
  width: 150px !important; /* 기존 200px → 2/3 크기 */
}

#tab-compare .input-box {
  justify-content: space-between; /* 넓은 영역 활용 */
  max-width: 900px;
  margin: 0 auto 10px auto !important;
  padding: 0;
}

/* 입력창과 버튼 정렬 최적화 */
#tab-compare .input-box button {
  flex-grow: 1;
  max-width: 100px;
  margin: 5px;
}

/* 체크박스 및 라벨 우측 정렬 */
#tab-compare .input-box input[type="checkbox"],
#tab-compare .input-box label {
  flex-grow: 1;
  text-align: right;
  margin: 0 5px;
}

/* 비교 결과 테이블 가로 영역 최적화 */
#tab-compare .compare-result {
  max-width: 100% !important;
  width: 100% !important;
  height: calc(100vh - 220px) !important;
  overflow: auto !important;
  margin: 0 auto;
  padding: 10px !important;
}

#tab-compare .compare-result table {
  width: max-content !important;
  min-width: 100% !important;
}

/* ✅ 선수 비교 검색 데이터 영역 넓이 정확히 조정 (중요!) */
#tab-compare .compare-result {
  max-width: 900px !important; /* 선수 입력창과 규정 경기 이상(14G) 체크박스 끝까지 정렬 */
  width: 100% !important;
  margin: 0 auto;
  padding: 10px !important;
  overflow: auto !important;
  height: calc(100vh - 220px) !important;
  box-sizing: border-box !important;
}

/* 테이블 너비 정확히 조정 */
#tab-compare .compare-result table {
  width: 100% !important;
  min-width: 100% !important;
  table-layout: fixed !important; /* 균일하게 너비 적용 */
}
/* 스크롤 시 데이터가 헤더 뒤로 보이는 현상 수정 */
#tab-compare .compare-result th {
  background-color: #282828 !important;
  position: sticky !important;
  top: 0 !important;
  z-index: 1000 !important;
}

/* 제목 헤더 배경으로 데이터가 보이지 않게 설정 */
#tab-compare .compare-result {
  position: relative;
  background-color: #121212 !important;
}

/* 차이 열 결과값 폰트 작게 조정 */
#tab-compare .compare-result td.diff-cell span {
  font-size: 0.9rem !important; /* 폰트 크기 1.2rem으로 지정 */
}

/* 빨간 정삼각형 아이콘 추가 스타일 */
.diff-positive::before {
  content: "▲";
  color: red;
  margin-right: 4px;
  font-size: 0.8rem;
}
/* 음수(-)값: 파란 역삼각형 아이콘 추가 */
.diff-negative::before {
  content: "▼";
  color: skyblue;
  margin-right: 5px;
  font-size: 0.8rem;
}

.category-checkboxes {
  display: grid;
  grid-template-columns: repeat(6, 1fr); /* 상단 6개 항목을 균등하게 나누기 위해 6칸 설정 */
  gap: 10px 20px; /* 세로 10px, 가로 20px 간격 */
  max-width: 900px;
  margin: 10px auto;
  justify-content: center;
  align-items: center;
}

.category-checkboxes label {
  white-space: nowrap;
  display: flex;
  align-items: center;
  justify-content: center;
}

.category-checkboxes input[type="checkbox"] {
  margin-right: 5px;
}

/* 상단 6개 항목 정확히 균등 배치 (한 행에 하나씩 정확히 들어가도록 설정) */
.category-checkboxes label:nth-child(-n+6) {
  grid-column: span 1; /* 6개 항목 정확히 한 칸씩 나눔 */
}

/* 하단 4개 항목은 더 넓게, 정확히 중앙 정렬 */
.category-checkboxes label:nth-child(n+7) {
  grid-column: span 1; /* 넓게 2칸씩 사용하여 여유를 둠 */
}

/* 하단 4개 항목이 정확히 중앙 정렬되도록 시작 위치 지정 */
.category-checkboxes label:nth-child(7) {
  grid-column-start: 2; /* 정확히 중앙 시작점 지정 */
}

.category-checkboxes label:nth-child(2) {
  margin-left: -40px; /* 슈팅 지표를 WinShare 지표에 맞춤 */
}

.category-checkboxes label:nth-child(10) {
  margin-left: -38px; /* Team내 비중 지표를 어시스트에 맞춤 */
}

    
  </style>
</head>
<body>
<div class="container">
  <h2>23-24 KBL Player Stats Analyzer</h2>
  <div class="tabs">
    <button class="tab-button active" data-tab="tab-all">선수 전체 검색</button>
    <button class="tab-button" data-tab="tab-player">선수 개인 검색</button>
    <button class="tab-button" data-tab="tab-compare">선수 비교 검색</button>
  </div>

<div id="tab-all" class="tab-content active">
  <div class="input-box">
    <input type="text" id="searchPlayerAll" placeholder="Search player...">
    <button onclick="searchPlayer()">Search</button>
    <input type="checkbox" id="minGamesCheckbox">
    <label for="minGamesCheckbox">규정 경기 이상(14G)</label>
  </div>

<div style="position:fixed; top:10px; right:10px; display:flex; align-items:center; gap:5px;">
  <input type="file" id="fileUploader" accept=".xlsx, .xls" style="font-size:0.75rem; color:#FFF;">
  <button onclick="loadLocalFile()" style="background:#555; color:#FFF; padding:4px 8px; border-radius:4px; font-size:0.75rem; cursor:pointer; border:none;">업로드</button>
</div>


  
  <div class="scroll-container" style="overflow:auto; flex:1;">
    <table id="statsTable" style="width:max-content; min-width:100%;">
     <thead>
  <tr>
    <th>Player</th>
    <th>Team</th>
    <th>출전 경기 수</th>
    <th>출전 시간(초)</th>
    <th>득점</th>
    <th>평균 득점</th>
    <th>FGA</th>
    <th>FG</th>
    <th>평균 FG 시도</th>
    <th>평균 FG 성공</th>
    <th>FG%</th>
    <th>2PA</th>
    <th>2P</th>
    <th>평균 2p 시도</th>
    <th>평균 2p 성공</th>
    <th>2P%</th>
    <th>3PA</th>
    <th>3P</th>
    <th>평균 3p 시도</th>
    <th>평균 3p 성공</th>
    <th>3P%</th>
    <th>FTA</th>
    <th>FT</th>
    <th>평균 FT 시도</th>
    <th>평균 FT 성공</th>
    <th>FT%</th>
    <th>리바운드</th>
    <th>평균 리바운드</th>
    <th>공격 리바운드</th>
    <th>평균 공격 리바운드</th>
    <th>수비 리바운드</th>
    <th>평균 수비 리바운드</th>
    <th>어시스트</th>
    <th>평균 어시스트</th>
    <th>스틸</th>
    <th>평균 스틸</th>
    <th>블록</th>
    <th>평균 블록</th>
    <th>턴오버</th>
    <th>평균 턴오버</th>
    <th>파울</th>
    <th>평균 파울</th>
    <th>WS</th>
    <th>WS/40</th>
    <th>Offensive_WS</th>
    <th>Defensive_WS</th>
    <th>PER</th>
    <th>EFF</th>
    <th>EFF/40</th>
    <th>Offensive_rating</th>
    <th>Defensive_rating</th>
    <th>USG%</th>
    <th>TS%</th>
    <th>eFG%</th>
    <th>3PAr</th>
    <th>FTr</th>
    <th>ORB%</th>
    <th>DRB%</th>
    <th>TRB%</th>
    <th>AST%</th>
    <th>STL%</th>
    <th>BS%</th>
    <th>TOV%</th>
  </tr>
</thead>

      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>


  <div id="tab-player" class="tab-content">
    <div class="input-box">
      <input type="text" id="searchPlayer" placeholder="Search player...">
      <button onclick="showPlayerStats()">Search</button>
      <input type="checkbox" id="minGames">
      <label for="minGames">규정 경기 이상(14G)</label>
    </div>
    <div class="player-name" id="playerName"></div>
    <div class="team-name" id="teamName"></div>
    <div class="stats-container" id="statsContainer"></div>
  </div>
<div id="tab-compare" class="tab-content">
<div class="input-box">
  <input type="text" id="comparePlayer1" placeholder="선수 1 이름 입력">
  <input type="text" id="comparePlayer2" placeholder="선수 2 이름 입력">
  <input type="text" id="comparePlayer3" placeholder="선수 3 이름 입력 (선택)">
<button onclick="comparePlayers()">Compare</button>
  <input type="checkbox" id="compareMinGames">
  <label for="compareMinGames">규정 경기 이상(14G)</label>
</div>
  <div id="categoryCheckboxes" class="category-checkboxes">
    <label><input type="checkbox" value="기본 정보" checked> 기본 정보</label>
    <label><input type="checkbox" value="슈팅 지표" checked> 슈팅 지표</label>
    <label><input type="checkbox" value="슈팅 성공률" checked> 슈팅 성공률</label>
    <label><input type="checkbox" value="리바운드 지표" checked> 리바운드 지표</label>
    <label><input type="checkbox" value="어시스트/스틸/블록 지표" checked> 어시스트/스틸/블록 지표</label>
    <label><input type="checkbox" value="기타 지표" checked> 기타 지표</label>
    <label><input type="checkbox" value="WinShare 지표" checked> WinShare 지표</label>
    <label><input type="checkbox" value="효율성 지표" checked> 효율성 지표</label>
    <label><input type="checkbox" value="2차 슈팅 지표" checked> 2차 슈팅 지표</label>
    <label><input type="checkbox" value="Team내 비중 지표" checked> Team내 비중 지표</label>
  </div>
  <div class="compare-result" id="compareResult">
  </div>
</div>
  <footer class="footer">
    © 2025 The Eroom Sports. All rights reserved.
  </footer>
</div>

<script>
const statsFormats = {
  "출전 경기 수": {unit: '경기', decimals: 0},
  "총 출전 시간(초)": {unit: '분 초', decimals: 0, convert: true},
  "득점": {unit: '점', decimals: 0},
  "평균 득점": {unit: '점', decimals: 2},
  "FGA": {unit: '개', decimals: 0},
  "FG": {unit: '개', decimals: 0},
  "평균 FG 시도": {unit: '개', decimals: 2},
  "평균 FG 성공": {unit: '개', decimals: 2},
  "FG%": {unit: '%', decimals: 2},
  "2PA": {unit: '개', decimals: 0},
  "2P": {unit: '개', decimals: 0},
  "평균 2p 시도": {unit: '개', decimals: 2},
  "평균 2p 성공": {unit: '개', decimals: 2},
  "2P%": {unit: '%', decimals: 2},
  "3PA": {unit: '개', decimals: 0},
  "3P": {unit: '개', decimals: 0},
  "평균 3p 시도": {unit: '개', decimals: 2},
  "평균 3p 성공": {unit: '개', decimals: 2},
  "3P%": {unit: '%', decimals: 2},
  "FTA": {unit: '개', decimals: 0},
  "FT": {unit: '개', decimals: 0},
  "평균 FT 시도": {unit: '개', decimals: 2},
  "평균 FT 성공": {unit: '개', decimals: 2},
  "FT%": {unit: '%', decimals: 2},
  "리바운드": {unit: '개', decimals: 0},
  "평균 리바운드": {unit: '개', decimals: 2},
  "공격 리바운드": {unit: '개', decimals: 0},
  "평균 공격 리바운드": {unit: '개', decimals: 2},
  "수비 리바운드": {unit: '개', decimals: 0},
  "평균 수비 리바운드": {unit: '개', decimals: 2},
  "어시스트": {unit: '개', decimals: 0},
  "평균 어시스트": {unit: '개', decimals: 2},
  "스틸": {unit: '개', decimals: 0},
  "평균 스틸": {unit: '개', decimals: 2},
  "블록": {unit: '개', decimals: 0},
  "평균 블록": {unit: '개', decimals: 2},
  "턴오버": {unit: '개', decimals: 0},
  "평균 턴오버": {unit: '개', decimals: 2},
  "파울": {unit: '개', decimals: 0},
  "평균 파울": {unit: '개', decimals: 2},
  "WS": {unit: '', decimals: 3},
  "WS/40": {unit: '', decimals: 3},
  "Offensive_WS": {unit: '', decimals: 3},
  "Defensive_WS": {unit: '', decimals: 3},
  "PER": {unit: '', decimals: 3},
  "EFF": {unit: '', decimals: 3},
  "EFF/40": {unit: '', decimals: 3},
  "Offensive_rating": {unit: '', decimals: 3},
  "Defensive_rating": {unit: '', decimals: 3},
  "TS%": {unit: '%', decimals: 3},
  "eFG%": {unit: '%', decimals: 3},
  "USG%": {unit: '%', decimals: 3},
  "3PAr": {unit: '', decimals: 3},
  "FTr": {unit: '', decimals: 3},
  "ORB%": {unit: '%', decimals: 3},
  "DRB%": {unit: '%', decimals: 3},
  "TRB%": {unit: '%', decimals: 3},
  "AST%": {unit: '%', decimals: 3},
  "STL%": {unit: '%', decimals: 3},
  "BS%": {unit: '%', decimals: 3},
  "TOV%": {unit: '%', decimals: 3}
};

  
 const tabs = document.querySelectorAll('.tab-button');
 const contents = document.querySelectorAll('.tab-content');
 
 tabs.forEach(tab => {
   tab.onclick = () => {
     tabs.forEach(t => t.classList.remove('active'));
     contents.forEach(c => c.classList.remove('active'));
     document.getElementById(tab.dataset.tab).classList.add('active');
     tab.classList.add('active');
   };
 });
 
 let originalData = [], highlightedPlayer = '', fixedRow = null;
 
async function loadPlayersData() {
  if (originalData.length === 0) {
    try {
      const url = 'https://raw.githubusercontent.com/dookie777/KBL-Player-Performance-Analyzer/main/23-24_KBL_stats.xlsx';
      const response = await fetch(url);
      const data = await response.arrayBuffer();

      const workbook = XLSX.read(data, { type: "array" });

      const firstSheet = workbook.SheetNames[0];
      originalData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet]);

      originalData.forEach(cols => {
        let minutes = parseInt(cols["m"]) || 0;
        let seconds = parseInt(cols["s"]) || 0;
        cols["총 출전 시간(초)"] = minutes * 60 + seconds;
      });

      console.log("웹 데이터 로딩 성공!", originalData); // ✅ 확인용 로그
      renderTable(originalData);

    } catch (error) {
      console.error("엑셀 데이터 로딩 오류:", error);
      alert("엑셀 데이터 로딩 중 문제가 발생했습니다.");
    }
  }
}




function renderTable(data) {
  const tableBody = document.getElementById('tableBody');
  tableBody.innerHTML = '';

  const minGamesOnly = document.getElementById('minGamesCheckbox').checked;
  const filteredData = minGamesOnly ? data.filter(cols => parseInt(cols["출전 경기 수"]) >= 14) : data;

  filteredData.forEach(cols => {
    const playerName = cols["Player"];
    const status = parseInt(cols["출전 경기 수"]) >= 14 ? '✅' : '⚠️';
    const totalSeconds = cols["총 출전 시간(초)"]; // 이미 계산된 값 정확히 사용

    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;

    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${playerName} <span class="${cols["출전 경기 수"] >= 20 ? 'valid' : 'warning'}">${status}</span></td>
      <td>${cols["Team"]}</td>
      <td>${cols["출전 경기 수"]}</td>
      <td data-time="${totalSeconds}">${minutes}분 ${seconds}초</td>
      <td>${cols["득점"]}</td>
      <td>${parseFloat(cols["평균 득점"]).toFixed(2)}</td>
      <td>${cols["FGA"]}</td>
      <td>${cols["FG"]}</td>
      <td>${cols["평균 FG 시도"]}</td>
      <td>${cols["평균 FG 성공"]}</td>
      <td>${cols["FG%"]}</td>
      <td>${cols["2PA"]}</td>
      <td>${cols["2P"]}</td>
      <td>${cols["평균 2p 시도"]}</td>
      <td>${cols["평균 2p 성공"]}</td>
      <td>${cols["2P%"]}</td>
      <td>${cols["3PA"]}</td>
      <td>${cols["3P"]}</td>
      <td>${cols["평균 3p 성공"]}</td>
      <td>${cols["평균 3p 성공"]}</td>
      <td>${cols["3P%"]}</td>
      <td>${cols["FTA"]}</td>
      <td>${cols["FT"]}</td>
      <td>${cols["평균 FT 시도"]}</td>
      <td>${cols["평균 FT 성공"]}</td>
      <td>${cols["FT%"]}</td>
      <td>${cols["리바운드"]}</td>
      <td>${cols["평균 리바운드"]}</td>
      <td>${cols["공격 리바운드"]}</td>
      <td>${cols["평균 공격 리바운드"]}</td>
      <td>${cols["수비 리바운드"]}</td>
      <td>${cols["평균 수비 리바운드"]}</td>
      <td>${cols["어시스트"]}</td>
      <td>${cols["평균 어시스트"]}</td>
      <td>${cols["스틸"]}</td>
      <td>${cols["평균 스틸"]}</td>
      <td>${cols["블록"]}</td>
      <td>${cols["평균 블록"]}</td>
      <td>${cols["턴오버"]}</td>
      <td>${cols["평균 턴오버"]}</td>
      <td>${cols["파울"]}</td>
      <td>${cols["평균 파울"]}</td>
      <td>${cols["WS"]}</td>
      <td>${cols["WS/40"]}</td>
      <td>${cols["Offensive_WS"]}</td>
      <td>${cols["Defensive_WS"]}</td>
      <td>${cols["PER"]}</td>
      <td>${cols["EFF"]}</td>
      <td>${cols["EFF/40"]}</td>
      <td>${cols["Offensive_rating"]}</td>
      <td>${cols["Defensive_rating"]}</td>
      <td>${cols["USG%"]}</td>
      <td>${cols["TS%"]}</td>
      <td>${cols["eFG%"]}</td>
      <td>${cols["3PAr"]}</td>
      <td>${cols["FTr"]}</td>
      <td>${cols["ORB%"]}</td>
      <td>${cols["DRB%"]}</td>
      <td>${cols["TRB%"]}</td>
      <td>${cols["AST%"]}</td>
      <td>${cols["STL%"]}</td>
      <td>${cols["BS%"]}</td>
      <td>${cols["TOV%"]}</td>
    `;
    tableBody.appendChild(row);
  });
}


 
function searchPlayer(){
  const query = document.getElementById('searchPlayerAll').value.toLowerCase().trim();
  clearFixedRow();
  const rows = document.querySelectorAll('#tableBody tr');
  let found = false;
  rows.forEach(row => {
    const name = row.cells[0].textContent.toLowerCase();
    row.classList.remove('highlight');
    if (name.includes(query)){
      found = true;
      row.classList.add('highlight');
      fixRow(row);
    }
  });
  if (!found) alert("Player not found!");
}
 
 function fixRow(row) {
  clearFixedRow();
  fixedRow = row.cloneNode(true);
  fixedRow.classList.add('fixed-row', 'highlight');
  fixedRow.style.position = 'sticky';
  fixedRow.style.top = '34px';
  fixedRow.style.backgroundColor = '#000';
  fixedRow.style.zIndex = '500';

  const releaseBtn = document.createElement('button');
  releaseBtn.textContent = '해제';
  releaseBtn.style.marginLeft = '10px';
  releaseBtn.onclick = () => {
    clearFixedRow();
    document.getElementById('searchPlayerAll').value = "";
  };

  fixedRow.cells[0].appendChild(releaseBtn);
  document.querySelector('#statsTable thead').after(fixedRow);
}

function clearFixedRow() {
  if (fixedRow) {
    const originalRows = document.querySelectorAll('#tableBody tr');
    originalRows.forEach(row => row.classList.remove('highlight'));
    fixedRow.remove();
  }
  fixedRow = null;
}
 
 const sortDirections = {};
 document.querySelectorAll('#statsTable th').forEach((header, index) => {
   sortDirections[index] = 'asc';
   header.onclick = () => sortTable(index);
 });
 
 function sortTable(i) {
   const tableBody = document.getElementById('tableBody');
   const rows = [...tableBody.rows];
   const direction = sortDirections[i] === 'asc' ? 'desc' : 'asc';
   sortDirections[i] = direction;
 
   rows.sort((a, b) => {
     let x, y;
     if (i === 3) {
       x = parseInt(a.cells[i].getAttribute('data-time'), 10);
       y = parseInt(b.cells[i].getAttribute('data-time'), 10);
     } else {
       x = parseFloat(a.cells[i].innerText) || 0;
       y = parseFloat(b.cells[i].innerText) || 0;
     }
     return direction === 'asc' ? x - y : y - x;
   }).forEach(row => tableBody.appendChild(row));
 
const currentSearch = document.getElementById('searchPlayerAll').value.trim();
   if (currentSearch !== "") searchPlayer(); 
   else clearFixedRow(); 
 }
 
 window.onload = loadPlayersData;
 
 document.getElementById('minGamesCheckbox').addEventListener('change', function() {
   renderTable(originalData);
 });

function calculateRank(filteredData, statKey, playerValue, isHigherBetter = true) {
  const sorted = filteredData
    .map(cols => parseFloat(cols[statKey]))
    .filter(value => !isNaN(value))
    .sort((a, b) => isHigherBetter ? b - a : a - b);

  return sorted.indexOf(parseFloat(playerValue)) + 1;
}

function showPlayerStats() {
  const playerNameInput = document.getElementById('searchPlayer').value.trim();

  const minGamesChecked = document.getElementById('minGames').checked;
  let filteredData = minGamesChecked ? originalData.filter(cols => parseInt(cols["출전 경기 수"]) >= 14) : originalData;

  const playerData = filteredData.find(cols => 
    cols["Player"].trim().toLowerCase().includes(playerNameInput.toLowerCase())
  );

  if (playerData) {
    document.getElementById('playerName').innerText = playerData["Player"];
    document.getElementById('teamName').innerText = '(' + playerData["Team"] + ')';

    const statsContainer = document.getElementById('statsContainer');
    statsContainer.innerHTML = '';

    statsContainer.innerHTML += createCard('기본 정보', [
      {label: '출전 경기 수', value: formatStatValue("출전 경기 수", playerData["출전 경기 수"]), rank: calculateRank(filteredData, "출전 경기 수", playerData["출전 경기 수"], true) + '위'},
      {label: '평균 출전 시간', value: formatStatValue("총 출전 시간(초)", playerData["총 출전 시간(초)"]), rank: calculateRank(filteredData, "총 출전 시간(초)", playerData["총 출전 시간(초)"], true) + '위'},
      {label: '총 득점', value: formatStatValue("득점", playerData["득점"]), rank: calculateRank(filteredData, "득점", playerData["득점"], true) + '위'},
      {label: '평균 득점', value: formatStatValue("평균 득점", playerData["평균 득점"]), rank: calculateRank(filteredData, "평균 득점", playerData["평균 득점"], true) + '위'}
    ], 'primary');

statsContainer.innerHTML += createCard('슈팅 지표', [
      {label: '평균 FG 시도', value: formatStatValue("평균 FG 시도", playerData["평균 FG 시도"]), rank: calculateRank(filteredData, "평균 FG 시도", playerData["평균 FG 시도"], true) + '위'},
      {label: '평균 FG 성공', value: formatStatValue("평균 FG 성공", playerData["평균 FG 성공"]), rank: calculateRank(filteredData, "평균 FG 성공", playerData["평균 FG 성공"], true) + '위'},
      {label: '평균 2p 시도', value: formatStatValue("평균 2p 시도", playerData["평균 2p 시도"]), rank: calculateRank(filteredData, "평균 2p 시도", playerData["평균 2p 시도"], true) + '위'},
      {label: '평균 2p 성공', value: formatStatValue("평균 2p 성공", playerData["평균 2p 성공"]), rank: calculateRank(filteredData, "평균 2p 성공", playerData["평균 2p 성공"], true) + '위'},
      {label: '평균 3p 성공', value: formatStatValue("평균 3p 성공", playerData["평균 3p 성공"]), rank: calculateRank(filteredData, "평균 3p 성공", playerData["평균 3p 성공"], true) + '위'},
      {label: '평균 FT 시도', value: formatStatValue("평균 FT 시도", playerData["평균 FT 시도"]), rank: calculateRank(filteredData, "평균 FT 시도", playerData["평균 FT 시도"], true) + '위'},
      {label: '평균 FT 성공', value: formatStatValue("평균 FT 성공", playerData["평균 FT 성공"]), rank: calculateRank(filteredData, "평균 FT 성공", playerData["평균 FT 성공"], true) + '위'}
], 'primary');

statsContainer.innerHTML += createCard('슈팅 성공률', [
  {
    label: 'FG%', 
    value: formatStatValue("FG%", playerData["FG%"]), 
    rank: calculateRank(filteredData, "FG%", playerData["FG%"], true) + '위'
  },
  {
    label: '2P%', 
    value: formatStatValue("2P%", playerData["2P%"]), 
    rank: calculateRank(filteredData, "2P%", playerData["2P%"], true) + '위'
  },
  {
    label: '3P%', 
    value: formatStatValue("3P%", playerData["3P%"]), 
    rank: calculateRank(filteredData, "3P%", playerData["3P%"], true) + '위'
  },
  {
    label: 'FT%', 
    value: formatStatValue("FT%", playerData["FT%"]), 
    rank: calculateRank(filteredData, "FT%", playerData["FT%"], true) + '위'
  }
], 'primary');

statsContainer.innerHTML += createCard('리바운드 지표', [
  {
    label: '총 리바운드', 
    value: formatStatValue("리바운드", playerData["리바운드"]), 
    rank: calculateRank(filteredData, "리바운드", playerData["리바운드"], true) + '위',
    highlight: true
  },
  {
    label: '평균 리바운드', 
    value: formatStatValue("평균 리바운드", playerData["평균 리바운드"]), 
    rank: calculateRank(filteredData, "평균 리바운드", playerData["평균 리바운드"], true) + '위',
    highlight: true
  },
  {
    label: '공격 리바운드', 
    value: formatStatValue("공격 리바운드", playerData["공격 리바운드"]), 
    rank: calculateRank(filteredData, "공격 리바운드", playerData["공격 리바운드"], true) + '위'
  },
  {
    label: '평균 공격 리바운드', 
    value: formatStatValue("평균 공격 리바운드", playerData["평균 공격 리바운드"]), 
    rank: calculateRank(filteredData, "평균 공격 리바운드", playerData["평균 공격 리바운드"], true) + '위'
  },
  {
    label: '수비 리바운드', 
    value: formatStatValue("수비 리바운드", playerData["수비 리바운드"]), 
    rank: calculateRank(filteredData, "수비 리바운드", playerData["수비 리바운드"], true) + '위'
  },
  {
    label: '평균 수비 리바운드', 
    value: formatStatValue("평균 수비 리바운드", playerData["평균 수비 리바운드"]), 
    rank: calculateRank(filteredData, "평균 수비 리바운드", playerData["평균 수비 리바운드"], true) + '위'
  }
], 'primary');

statsContainer.innerHTML += createCard('어시스트/스틸/블록 지표', [
  {
    label: '총 어시스트', 
    value: formatStatValue("어시스트", playerData["어시스트"]), 
    rank: calculateRank(filteredData, "어시스트", playerData["어시스트"], true) + '위'
  },
  {
    label: '평균 어시스트', 
    value: formatStatValue("평균 어시스트", playerData["평균 어시스트"]), 
    rank: calculateRank(filteredData, "평균 어시스트", playerData["평균 어시스트"], true) + '위'
  },
  {
    label: '총 스틸', 
    value: formatStatValue("스틸", playerData["스틸"]), 
    rank: calculateRank(filteredData, "스틸", playerData["스틸"], true) + '위'
  },
  {
    label: '평균 스틸', 
    value: formatStatValue("평균 스틸", playerData["평균 스틸"]), 
    rank: calculateRank(filteredData, "평균 스틸", playerData["평균 스틸"], true) + '위'
  },
  {
    label: '총 블록', 
    value: formatStatValue("블록", playerData["블록"]), 
    rank: calculateRank(filteredData, "블록", playerData["블록"], true) + '위'
  },
  {
    label: '평균 블록', 
    value: formatStatValue("평균 블록", playerData["평균 블록"]), 
    rank: calculateRank(filteredData, "평균 블록", playerData["평균 블록"], true) + '위'
  }
], 'primary');

statsContainer.innerHTML += createCard('기타 지표', [
  {
    label: '턴오버', 
    value: formatStatValue("턴오버", playerData["턴오버"]), 
    rank: calculateRank(filteredData, "턴오버", playerData["턴오버"], false) + '위'
  },
  {
    label: '평균 턴오버', 
    value: formatStatValue("평균 턴오버", playerData["평균 턴오버"]), 
    rank: calculateRank(filteredData, "평균 턴오버", playerData["평균 턴오버"], false) + '위'
  },
  {
    label: '파울', 
    value: formatStatValue("파울", playerData["파울"]), 
    rank: calculateRank(filteredData, "파울", playerData["파울"], false) + '위'
  },
  {
    label: '평균 파울', 
    value: formatStatValue("평균 파울", playerData["평균 파울"]), 
    rank: calculateRank(filteredData, "평균 파울", playerData["평균 파울"], false) + '위'
  }
], 'primary');



statsContainer.innerHTML += createCard('WinShare 지표', [
  {label: 'WS', value: formatStatValue("WS", playerData["WS"]), rank: calculateRank(filteredData, "WS", playerData["WS"], true) + '위', highlight: true},
  {label: 'WS/40', value: formatStatValue("WS/40", playerData["WS/40"]), rank: calculateRank(filteredData, "WS/40", playerData["WS/40"], true) + '위'},
  {label: 'Offensive_WS', value: formatStatValue("Offensive_WS", playerData["Offensive_WS"]), rank: calculateRank(filteredData, "Offensive_WS", playerData["Offensive_WS"], true) + '위'},
  {label: 'Defensive_WS', value: formatStatValue("Defensive_WS", playerData["Defensive_WS"]), rank: calculateRank(filteredData, "Defensive_WS", playerData["Defensive_WS"], true) + '위'}
], 'secondary');

statsContainer.innerHTML += createCard('효율성 지표', [
  {label: 'PER', value: formatStatValue("PER", playerData["PER"]), rank: calculateRank(filteredData, "PER", playerData["PER"], true) + '위'},
  {label: 'EFF', value: formatStatValue("EFF", playerData["EFF"]), rank: calculateRank(filteredData, "EFF", playerData["EFF"], true) + '위'},
  {label: 'EFF/40', value: formatStatValue("EFF/40", playerData["EFF/40"]), rank: calculateRank(filteredData, "EFF/40", playerData["EFF/40"], true) + '위'},
  {label: 'Offensive_rating', value: formatStatValue("Offensive_rating", playerData["Offensive_rating"]), rank: calculateRank(filteredData, "Offensive_rating", playerData["Offensive_rating"], true) + '위'},
  {label: 'Defensive_rating', value: formatStatValue("Defensive_rating", playerData["Defensive_rating"]), rank: calculateRank(filteredData, "Defensive_rating", playerData["Defensive_rating"], false) + '위'},
  {label: 'USG%', value: formatStatValue("USG%", playerData["USG%"]), rank: calculateRank(filteredData, "USG%", playerData["USG%"], true) + '위'}
], 'secondary');

statsContainer.innerHTML += createCard('2차 슈팅 지표', [
  {label: 'TS%', value: formatStatValue("TS%", playerData["TS%"]), rank: calculateRank(filteredData, "TS%", playerData["TS%"], true) + '위'},
  {label: 'eFG%', value: formatStatValue("eFG%", playerData["eFG%"]), rank: calculateRank(filteredData, "eFG%", playerData["eFG%"], true) + '위'},
  {label: '3PAr', value: formatStatValue("3PAr", playerData["3PAr"]), rank: calculateRank(filteredData, "3PAr", playerData["3PAr"], true) + '위'},
  {label: 'FTr', value: formatStatValue("FTr", playerData["FTr"]), rank: calculateRank(filteredData, "FTr", playerData["FTr"], true) + '위'}
], 'secondary');

statsContainer.innerHTML += createCard('Team내 비중 지표', [
  {label: 'ORB%', value: formatStatValue("ORB%", playerData["ORB%"]), rank: calculateRank(filteredData, "ORB%", playerData["ORB%"], true) + '위'},
  {label: 'DRB%', value: formatStatValue("DRB%", playerData["DRB%"]), rank: calculateRank(filteredData, "DRB%", playerData["DRB%"], true) + '위'},
  {label: 'TRB%', value: formatStatValue("TRB%", playerData["TRB%"]), rank: calculateRank(filteredData, "TRB%", playerData["TRB%"], true) + '위'},
  {label: 'AST%', value: formatStatValue("AST%", playerData["AST%"]), rank: calculateRank(filteredData, "AST%", playerData["AST%"], true) + '위'},
  {label: 'STL%', value: formatStatValue("STL%", playerData["STL%"]), rank: calculateRank(filteredData, "STL%", playerData["STL%"], true) + '위'},
  {label: 'BS%', value: formatStatValue("BS%", playerData["BS%"]), rank: calculateRank(filteredData, "BS%", playerData["BS%"], true) + '위'},
  {label: 'TOV%', value: formatStatValue("TOV%", playerData["TOV%"]), rank: calculateRank(filteredData, "TOV%", playerData["TOV%"], false) + '위'}
], 'team-stats');



  } else {
    alert('선수를 찾을 수 없습니다.');
  }
}
 document.getElementById('searchPlayerAll').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    searchPlayer();
  }
});

function createCard(title, stats, type = 'primary') {
  return `
    <div class="card ${type}">
      <h3>${title}</h3>
      <table>
        <thead>
          <tr>
            <th>지표</th>
            <th>기록</th>
            <th>순위</th>
          </tr>
        </thead>
        <tbody>
          ${stats.map(stat => `
            <tr>
              <td>${stat.label}</td>
              <td>${stat.value}</td>
              <td>${stat.rank}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}


// 개인 선수 탭 검색창에서 엔터 키 동작
document.getElementById('searchPlayer').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    showPlayerStats();
  }
});
// ✅ 선수 개인 검색 페이지 체크박스 이벤트 추가 (완벽해결)
document.getElementById('minGames').addEventListener('change', function() {
  const playerInput = document.getElementById('searchPlayer').value.trim();
  if (playerInput !== "") {
    showPlayerStats();  // Player 입력되어 있으면 바로 다시 검색
  }
});

// ✅ 최종 완성된 전체 지표 포함 비교 함수
function formatStatValue(key, value) {
  const format = statsFormats[key];
  if (!format) return value;

  let formattedValue;
  if (key === "총 출전 시간(초)" || format.unit === '분 초') {
    const totalSeconds = parseInt(value, 10);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    formattedValue = `${minutes}분 ${seconds}초`;
  } else {
    formattedValue = parseFloat(value).toFixed(format.decimals);
  }

  return formattedValue + (format.unit && format.unit !== '분 초' ? format.unit : '');
}
function comparePlayers() {
  const player1 = document.getElementById('comparePlayer1').value.trim();
  const player2 = document.getElementById('comparePlayer2').value.trim();
  const player3 = document.getElementById('comparePlayer3').value.trim();
  const minGamesChecked = document.getElementById('compareMinGames').checked;

  let filteredData = minGamesChecked
    ? originalData.filter(cols => parseInt(cols["출전 경기 수"]) >= 14)
    : originalData;

  const playersData = [player1, player2, player3]
    .filter(name => name !== '')
    .map(name => filteredData.find(cols => cols["Player"].trim().toLowerCase().includes(name.trim().toLowerCase())));

  if (playersData.some(data => data === undefined)) {
    alert('선수 이름을 정확히 입력해주세요.');
    return;
  }

  const statsLabels = [
    {label: '출전 경기 수', key: "출전 경기 수", higherBetter: true},
    {label: '평균 출전 시간', key: "총 출전 시간(초)", higherBetter: true},
    {label: '득점', key: "득점", higherBetter: true},
    {label: '평균 득점', key: "평균 득점", higherBetter: true},
    {label: 'FGA', key: "FGA", higherBetter: true},
    {label: 'FG', key: "FG", higherBetter: true},
    {label: '평균 FG 시도', key: "평균 FG 시도", higherBetter: true},
    {label: '평균 FG 성공', key: "평균 FG 성공", higherBetter: true},
    {label: 'FG%', key: "FG%", higherBetter: true},
    {label: '2PA', key: "2PA", higherBetter: true},
    {label: '2P', key: "2P", higherBetter: true},
    {label: '평균 2p 시도', key: "평균 2p 시도", higherBetter: true},
    {label: '평균 2p 성공', key: "평균 2p 성공", higherBetter: true},
    {label: '2P%', key: "2P%", higherBetter: true},
    {label: '3PA', key: "3PA", higherBetter: true},
    {label: '3P', key: "3P", higherBetter: true},
    {label: '평균 3p 시도', key: "평균 3p 시도", higherBetter: true},
    {label: '평균 3p 성공', key: "평균 3p 성공", higherBetter: true},
    {label: '3P%', key: "3P%", higherBetter: true},
    {label: 'FTA', key: "FTA", higherBetter: true},
    {label: 'FT', key: "FT", higherBetter: true},
    {label: '평균 FT 시도', key: "평균 FT 시도", higherBetter: true},
    {label: '평균 FT 성공', key: "평균 FT 성공", higherBetter: true},
    {label: 'FT%', key: "FT%", higherBetter: true},
    {label: '리바운드', key: "리바운드", higherBetter: true},
    {label: '평균 리바운드', key: "평균 리바운드", higherBetter: true},
    {label: '공격 리바운드', key: "공격 리바운드", higherBetter: true},
    {label: '평균 공격 리바운드', key: "평균 공격 리바운드", higherBetter: true},
    {label: '수비 리바운드', key: "수비 리바운드", higherBetter: true},
    {label: '평균 수비 리바운드', key: "평균 수비 리바운드", higherBetter: true},
    {label: '어시스트', key: "어시스트", higherBetter: true},
    {label: '평균 어시스트', key: "평균 어시스트", higherBetter: true},
    {label: '스틸', key: "스틸", higherBetter: true},
    {label: '평균 스틸', key: "평균 스틸", higherBetter: true},
    {label: '블록', key: "블록", higherBetter: true},
    {label: '평균 블록', key: "평균 블록", higherBetter: true},
    {label: '턴오버', key: "턴오버", higherBetter: false},
    {label: '평균 턴오버', key: "평균 턴오버", higherBetter: false},
    {label: '파울', key: "파울", higherBetter: false},
    {label: '평균 파울', key: "평균 파울", higherBetter: false},
    {label: 'WS', key: "WS", higherBetter: true},
    {label: 'WS/40', key: "WS/40", higherBetter: true},
    {label: 'Offensive_WS', key: "Offensive_WS", higherBetter: true},
    {label: 'Defensive_WS', key: "Defensive_WS", higherBetter: true},
    {label: 'Offensive_rating', key: "Offensive_rating", higherBetter: true},
    {label: 'Defensive_rating', key: "Defensive_rating", higherBetter: false},
    {label: 'PER', key: "PER", higherBetter: true},
    {label: 'EFF', key: "EFF", higherBetter: true},
    {label: 'EFF/40', key: "EFF/40", higherBetter: true},
    {label: 'TS%', key: "TS%", higherBetter: true},
    {label: 'eFG%', key: "eFG%", higherBetter: true},
    {label: 'USG%', key: "USG%", higherBetter: true},
    {label: '3PAr', key: "3PAr", higherBetter: true},
    {label: 'FTr', key: "FTr", higherBetter: true},
    {label: 'ORB%', key: "ORB%", higherBetter: true},
    {label: 'DRB%', key: "DRB%", higherBetter: true},
    {label: 'TRB%', key: "TRB%", higherBetter: true},
    {label: 'AST%', key: "AST%", higherBetter: true},
    {label: 'STL%', key: "STL%", higherBetter: true},
    {label: 'BS%', key: "BS%", higherBetter: true},
    {label: 'TOV%', key: "TOV%", higherBetter: false}
  ];

  let tableHTML = `<table><thead><tr><th>지표</th>${playersData.map(p => `<th>${p["Player"]} (${p["Team"]})</th>`).join('')}${playersData.length === 2 ? `<th>차이</th>` : ''}</tr></thead><tbody>`;

  statsLabels.forEach(stat => {
    const values = playersData.map(p => parseFloat(p[stat.key]) || 0);
    const ranks = values.map(val => calculateRank(filteredData, stat.key, val, stat.higherBetter));

    let highlightClass = [];
    if (values.length >= 2) {
      const sortedValues = [...values].sort((a, b) => stat.higherBetter ? b - a : a - b);
      highlightClass = values.map(v => {
        if (v === sortedValues[0]) return 'highlight-first';
        if (values.length > 2 && v === sortedValues[1]) return 'highlight-second';
        return 'highlight-third';
      });
    }

    tableHTML += `<tr data-category="${getCategoryByStat(stat.label)}"><td>${stat.label}</td>`;

    values.forEach((value, idx) => {
      tableHTML += `<td class="${highlightClass[idx]}">${formatStatValue(stat.key, value)} (${ranks[idx]}위)</td>`;
    });

    if (playersData.length === 2) {
      const diff = values[0] - values[1];
      const diffClass = diff > 0 ? 'diff-positive' : diff < 0 ? 'diff-negative' : '';
const format = statsFormats[stat.key] || {unit: '', decimals: 2};

let formattedDiff;
if (stat.key === "총 출전 시간(초)" || format.unit === '분 초') {
  const diffSeconds = Math.abs(diff);
  const minutes = Math.floor(diffSeconds / 60);
  const seconds = diffSeconds % 60;
  formattedDiff = `${minutes}분 ${seconds}초`;
} else if (format.decimals === 0) {
  formattedDiff = `${Math.abs(diff)}${format.unit}`;
} else {
  formattedDiff = `${Math.abs(diff).toFixed(format.decimals)}${format.unit}`;
}



      tableHTML += `<td class="diff-cell ${diffClass}"><span>${formattedDiff}</span></td>`;
    }

    tableHTML += '</tr>';
  });

  tableHTML += '</tbody></table>';
  document.getElementById('compareResult').innerHTML = tableHTML;
  filterCompareTable();
}




// 엔터키 입력 기능 추가 (유지)
['comparePlayer1', 'comparePlayer2', 'comparePlayer3'].forEach(id => {
  document.getElementById(id).addEventListener('keypress', function(e) {
if (e.key === 'Enter') comparePlayers();
  });
});

// 체크박스 즉시 반응 추가 (유지)
document.getElementById('compareMinGames').addEventListener('change', () => {
  comparePlayers();
});

// 체크박스 이벤트 핸들러 추가
document.querySelectorAll('#categoryCheckboxes input[type="checkbox"]').forEach(checkbox => {
  checkbox.addEventListener('change', filterCompareTable);
});

// 체크박스 필터링 함수 정의
function filterCompareTable() {
  const checkedCategories = Array.from(document.querySelectorAll('#categoryCheckboxes input[type="checkbox"]:checked'))
                                 .map(cb => cb.value);

  document.querySelectorAll('#compareResult tbody tr').forEach(row => {
    const category = row.getAttribute('data-category');
    row.style.display = checkedCategories.includes(category) ? '' : 'none';
  });
}

// 지표 → 카테고리 변환 함수 추가 (맨 끝에 추가)
function getCategoryByStat(statLabel) {
  const categoryMap = {
    '출전 경기 수': '기본 정보',
    '평균 출전 시간': '기본 정보',
    '득점': '기본 정보',
    '평균 득점': '기본 정보',

    '평균 FG 시도': '슈팅 지표',
    '평균 FG 성공': '슈팅 지표',
    '평균 2p 시도': '슈팅 지표',
    '평균 2p 성공': '슈팅 지표',
    '평균 3p 성공': '슈팅 지표',
    '평균 3p 성공': '슈팅 지표',
    '평균 FT 시도': '슈팅 지표',
    '평균 FT 성공': '슈팅 지표',

    'FG%': '슈팅 성공률',
    '2P%': '슈팅 성공률',
    '3P%': '슈팅 성공률',
    'FT%': '슈팅 성공률',

    '리바운드': '리바운드 지표',
    '평균 리바운드': '리바운드 지표',
    '공격 리바운드': '리바운드 지표',
    '평균 공격 리바운드': '리바운드 지표',
    '수비 리바운드': '리바운드 지표',
    '평균 수비 리바운드': '리바운드 지표',

    '어시스트': '어시스트/스틸/블록 지표',
    '평균 어시스트': '어시스트/스틸/블록 지표',
    '스틸': '어시스트/스틸/블록 지표',
    '평균 스틸': '어시스트/스틸/블록 지표',
    '블록': '어시스트/스틸/블록 지표',
    '평균 블록': '어시스트/스틸/블록 지표',

    '턴오버': '기타 지표',
    '평균 턴오버': '기타 지표',
    '파울': '기타 지표',
    '평균 파울': '기타 지표',

    'WS': 'WinShare 지표',
    'WS/40': 'WinShare 지표',
    'Offensive_WS': 'WinShare 지표',
    'Defensive_WS': 'WinShare 지표',

    'PER': '효율성 지표',
    'EFF': '효율성 지표',
    'EFF/40': '효율성 지표',
    'Offensive_rating': '효율성 지표',
    'Defensive_rating': '효율성 지표',
    'USG%': '효율성 지표',

    'TS%': '2차 슈팅 지표',
    'eFG%': '2차 슈팅 지표',
    '3PAr': '2차 슈팅 지표',
    'FTr': '2차 슈팅 지표',

    'ORB%': 'Team내 비중 지표',
    'DRB%': 'Team내 비중 지표',
    'TRB%': 'Team내 비중 지표',
    'AST%': 'Team내 비중 지표',
    'STL%': 'Team내 비중 지표',
    'BS%': 'Team내 비중 지표',
    'TOV%': 'Team내 비중 지표'
  };
  return categoryMap[statLabel] || '기타 지표';
}

// 최초 실행 시 모든 체크박스 선택 상태로 시작
window.addEventListener('DOMContentLoaded', () => {
  filterCompareTable();
});

async function loadLocalFile() {
  const fileInput = document.getElementById('fileUploader');

  if (fileInput.files.length === 0) {
    alert('엑셀 파일을 선택해 주세요.');
    return;
  }

  const file = fileInput.files[0];
  const reader = new FileReader();

  reader.onload = function(e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, {type: 'array'});

    const firstSheet = workbook.SheetNames[0];
    originalData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet]);

    originalData.forEach(cols => {
      let minutes = parseInt(cols["m"]) || 0;
      let seconds = parseInt(cols["s"]) || 0;
      cols["총 출전 시간(초)"] = minutes * 60 + seconds;
    });

    renderTable(originalData);
    alert("엑셀 파일이 성공적으로 로드되었습니다!");
  };

  reader.onerror = function(e) {
    console.error("파일 로딩 오류", e);
    alert("파일 로딩 중 오류가 발생했습니다.");
  };

  reader.readAsArrayBuffer(file);
}

  
 </script>

 
 </body>
 </html>
