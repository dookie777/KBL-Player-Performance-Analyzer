<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>KBL Player Stats Analyzer</title>
  <style>
body {
  background: #121212;
  color: #FFF;
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
  overflow: hidden;
}

.container {
  max-width: 1200px;
  margin: auto;
  padding: 20px;
  box-sizing: border-box;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

h2 {
  text-align: center;
  color: #FFA500;
}

.tabs {
  text-align: center;
  margin-bottom: 15px;
}

.tabs button {
  background: #282828;
  color: #FFF;
  padding: 10px 20px;
  border: none;
  cursor: pointer;
  margin: 0 5px;
  font-weight: bold;
  width: 160px;
}

.tabs button.active {
  background: #E0E0E0;
  color: #000;
}

.tab-content {
  display: none !important;
  flex-direction: column;
  flex: 1;
  overflow: hidden !important;
}

.tab-content.active {
  display: flex !important;
}

.input-box {
  display: flex;
  justify-content: center;
  align-items: center;
  flex-wrap: wrap;
  margin-bottom: 20px;
}

.input-box input[type="text"],
.input-box button {
  height: 42px;
  padding: 5px 15px;
  font-size: 0.9rem;
  border-radius: 5px;
  border: none;
  margin: 5px;
}

.input-box input[type="text"] {
  width: 250px;
  font-size: 1rem;
}

.input-box button {
  background-color: #88c2dd;
  color: #121212;
  cursor: pointer;
  font-weight: bold;
}

.input-box input[type="checkbox"] {
  margin: 0 5px;
}

.input-box label {
  color: #FFF;
  font-size: 0.9rem;
  cursor: pointer;
  user-select: none;
}

.scroll-container, .stats-container, .compare-result {
  flex: 1;
  overflow: auto;
}

.scroll-container::-webkit-scrollbar,
.stats-container::-webkit-scrollbar,
.compare-result::-webkit-scrollbar {
  width: 10px;
  height: 10px;
}

.scroll-container::-webkit-scrollbar-track,
.stats-container::-webkit-scrollbar-track,
.compare-result::-webkit-scrollbar-track {
  background: #121212;
  border-radius: 5px;
}

.scroll-container::-webkit-scrollbar-thumb,
.stats-container::-webkit-scrollbar-thumb,
.compare-result::-webkit-scrollbar-thumb {
  background: #555;
  border-radius: 5px;
  border: 2px solid #121212;
}

.scroll-container::-webkit-scrollbar-thumb:hover,
.stats-container::-webkit-scrollbar-thumb:hover,
.compare-result::-webkit-scrollbar-thumb:hover {
  background: #FFA500;
}

table {
  border-collapse: collapse;
  white-space: nowrap;
  width: max-content;
}

th, td {
  padding: 8px;
  border-bottom: 1px solid #333;
  font-size: 0.85rem;
  text-align: center;
  background: #181818;
  font-weight: bold;
}

thead th {
  background: #282828;
  position: sticky;
  top: 0;
  cursor: pointer;
  z-index: 500;
}

#tab-all th:nth-child(1), #tab-all td:nth-child(1),
#tab-all th:nth-child(2), #tab-all td:nth-child(2) {
  position: sticky;
  background-color: #282828 !important;
  z-index: 400;
}

#tab-all th:nth-child(1), #tab-all td:nth-child(1) {
  left: 0;
}

#tab-all th:nth-child(2), #tab-all td:nth-child(2) {
  left: 150px;
}

.highlight { 
  color: #FFFF55 !important; 
  font-weight: bold; 
}

.player-name {
  font-size: 2rem;
  font-weight: bold;
  margin: 15px 0 5px;
  text-align: center;
}

.team-name {
  font-size: 1rem;
  text-align: center;
  margin-bottom: 15px;
}

.stats-container {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 15px;
  margin-top: 20px;
  padding-bottom: 60px;
}

.card {
  background-color: rgba(255,255,255,0.05);
  padding: 10px;
  border-radius: 10px;
  text-align: center;
  min-height: 350px;
}

.card.primary:nth-child(2) { min-height: 420px; }
.card.primary h3 { color: #FFA500; }
.card.secondary h3 { color: #88c2dd; }

.card h3 {
  margin: 0 0 8px;
  font-size: 1.1rem;
}

.card table {
  width: 100%;
}

.card th, .card td {
  padding: 8px 5px;
  border-bottom: 1px solid rgba(255,255,255,0.2);
}

.card.team-stats {
  min-height: 380px !important;
}

.card.team-stats h3 {
  color: #88c2dd !important;
}

#tab-compare .compare-result {
  max-width: none !important;
  height: calc(100vh - 260px);
  padding: 15px;
  margin: 0 auto;
}

#tab-compare .compare-result table {
  table-layout: auto !important;
  transform: none !important;
}

#tab-compare .compare-result th,
#tab-compare .compare-result td {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding: 10px 15px !important;
  font-size: 0.85rem !important;
}

#tab-compare .compare-result th {
  background-color: #282828 !important;
  padding: 15px !important;
}

.highlight-first {
  background-color: rgba(255,140,0,0.95) !important;
  color: #FFF !important;
}

.highlight-second {
  background-color: rgba(70,150,200,0.95) !important;
  color: #FFF !important;
}

.highlight-third {
  background-color: rgba(160,160,160,0.95) !important;
  color: #FFF !important;
}

.footer {
  text-align: center;
  padding: 10px;
  font-size: 0.8rem;
  color: #888;
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background-color: #000;
  pointer-events: none;
}
/* ✅ 1페이지 헤더 완벽 고정 (긴급 해결 재적용) */
#tab-all th:nth-child(1),
#tab-all th:nth-child(2) {
  position: sticky;
  top: 0 !important;
  background-color: #282828 !important;
  z-index: 500 !important;
}

#tab-all td:nth-child(1),
#tab-all td:nth-child(2) {
  position: sticky;
  left: 0;
  background-color: #282828 !important;
  z-index: 400 !important;
}

#tab-all th:nth-child(2),
#tab-all td:nth-child(2) {
  left: 150px;
}

/* ✅ 선수 개인 검색 페이지 간격 축소 (중요 수정) */
#tab-player .input-box {
  margin-bottom: 10px !important; /* 기존 20px → 절반으로 수정 */
}

#tab-player .player-name {
  margin: 8px 0 3px 0 !important; /* 기존 15px, 5px → 절반으로 수정 */
}

#tab-player .team-name {
  margin-bottom: 8px !important; /* 기존 15px → 절반으로 수정 */
}

#tab-player .stats-container {
  margin-top: 10px !important; /* 기존 20px → 절반으로 수정 */
}

/* ✅ 선수 비교 페이지 입력창 크기 및 영역 최적화 (중요 수정) */
#tab-compare .input-box input[type="text"] {
  width: 150px !important; /* 기존 200px → 2/3 크기 */
}

#tab-compare .input-box {
  justify-content: space-between; /* 넓은 영역 활용 */
  max-width: 900px;
  margin: 0 auto 10px auto !important;
  padding: 0;
}

/* 입력창과 버튼 정렬 최적화 */
#tab-compare .input-box button {
  flex-grow: 1;
  max-width: 100px;
  margin: 5px;
}

/* 체크박스 및 라벨 우측 정렬 */
#tab-compare .input-box input[type="checkbox"],
#tab-compare .input-box label {
  flex-grow: 1;
  text-align: right;
  margin: 0 5px;
}

/* 비교 결과 테이블 가로 영역 최적화 */
#tab-compare .compare-result {
  max-width: 100% !important;
  width: 100% !important;
  height: calc(100vh - 220px) !important;
  overflow: auto !important;
  margin: 0 auto;
  padding: 10px !important;
}

#tab-compare .compare-result table {
  width: max-content !important;
  min-width: 100% !important;
}

/* ✅ 선수 비교 검색 데이터 영역 넓이 정확히 조정 (중요!) */
#tab-compare .compare-result {
  max-width: 900px !important; /* 선수 입력창과 규정 경기 이상(14G) 체크박스 끝까지 정렬 */
  width: 100% !important;
  margin: 0 auto;
  padding: 10px !important;
  overflow: auto !important;
  height: calc(100vh - 220px) !important;
  box-sizing: border-box !important;
}

/* 테이블 너비 정확히 조정 */
#tab-compare .compare-result table {
  width: 100% !important;
  min-width: 100% !important;
  table-layout: fixed !important; /* 균일하게 너비 적용 */
}
/* 스크롤 시 데이터가 헤더 뒤로 보이는 현상 수정 */
#tab-compare .compare-result th {
  background-color: #282828 !important;
  position: sticky !important;
  top: 0 !important;
  z-index: 1000 !important;
}

/* 제목 헤더 배경으로 데이터가 보이지 않게 설정 */
#tab-compare .compare-result {
  position: relative;
  background-color: #121212 !important;
}

/* 차이 열 결과값 폰트 작게 조정 */
#tab-compare .compare-result td.diff-cell {
  font-size: 0.75rem !important; /* 기존보다 폰트 작게 조정 */
}

/* 빨간 정삼각형 아이콘 추가 스타일 */
.diff-positive::before {
  content: "▲";
  color: red;
  margin-right: 4px;
  font-size: 0.75rem;
}
/* 음수(-)값: 파란 역삼각형 아이콘 추가 */
.diff-negative::before {
  content: "▼";
  color: skyblue;
  margin-right: 5px;
  font-size: 0.75rem;
}
  </style>
</head>
<body>
<div class="container">
  <h2>KBL Player Stats Analyzer</h2>
  <div class="tabs">
    <button class="tab-button active" data-tab="tab-all">선수 전체 검색</button>
    <button class="tab-button" data-tab="tab-player">선수 개인 검색</button>
    <button class="tab-button" data-tab="tab-compare">선수 비교 검색</button>
  </div>

<div id="tab-all" class="tab-content active">
  <div class="input-box">
    <input type="text" id="searchPlayerAll" placeholder="Search player...">
    <button onclick="searchPlayer()">Search</button>
    <input type="checkbox" id="minGamesCheckbox">
    <label for="minGamesCheckbox">규정 경기 이상(14G)</label>
  </div>
  <div class="scroll-container" style="overflow:auto; flex:1;">
    <table id="statsTable" style="width:max-content; min-width:100%;">
     <thead>
  <tr>
    <th>선수 이름</th>
    <th>팀</th>
    <th>경기수(G)</th>
    <th>출전시간</th>
    <th>득점</th>
    <th>평균 득점</th>
    <th>FGA</th>
    <th>FG</th>
    <th>평균 FG 시도</th>
    <th>평균 FG 성공</th>
    <th>FG%</th>
    <th>2PA</th>
    <th>2P</th>
    <th>평균 2P 시도</th>
    <th>평균 2P 성공</th>
    <th>2P%</th>
    <th>3PA</th>
    <th>3P</th>
    <th>평균 3P 시도</th>
    <th>평균 3P 성공</th>
    <th>3P%</th>
    <th>FTA</th>
    <th>FT</th>
    <th>평균 FT 시도</th>
    <th>평균 FT 성공</th>
    <th>FT%</th>
    <th>리바운드</th>
    <th>평균 리바운드</th>
    <th>공격 리바운드</th>
    <th>평균 공격 리바운드</th>
    <th>수비 리바운드</th>
    <th>평균 수비 리바운드</th>
    <th>어시스트</th>
    <th>평균 어시스트</th>
    <th>스틸</th>
    <th>평균 스틸</th>
    <th>블록</th>
    <th>평균 블록</th>
    <th>턴오버</th>
    <th>평균 턴오버</th>
    <th>파울</th>
    <th>평균 파울</th>
    <th>WS</th>
    <th>WS/40</th>
    <th>Offensive WS</th>
    <th>Defensive WS</th>
    <th>PER</th>
    <th>EFF</th>
    <th>EFF/40</th>
    <th>Offensive Rating</th>
    <th>Defensive Rating</th>
    <th>USG%</th>
    <th>TS%</th>
    <th>eFG%</th>
    <th>3PAr</th>
    <th>FTr</th>
    <th>ORB%</th>
    <th>DRB%</th>
    <th>TRB%</th>
    <th>AST%</th>
    <th>STL%</th>
    <th>BLK%</th>
    <th>TOV%</th>
  </tr>
</thead>

      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>


  <div id="tab-player" class="tab-content">
    <div class="input-box">
      <input type="text" id="searchPlayer" placeholder="Search player...">
      <button onclick="showPlayerStats()">Search</button>
      <input type="checkbox" id="minGames">
      <label for="minGames">규정 경기 이상(14G)</label>
    </div>
    <div class="player-name" id="playerName"></div>
    <div class="team-name" id="teamName"></div>
    <div class="stats-container" id="statsContainer"></div>
  </div>
<div id="tab-compare" class="tab-content">
<div class="input-box">
  <input type="text" id="comparePlayer1" placeholder="선수 1 이름 입력">
  <input type="text" id="comparePlayer2" placeholder="선수 2 이름 입력">
  <input type="text" id="comparePlayer3" placeholder="선수 3 이름 입력 (선택)">
  <button onclick="comparePlayers()">비교하기</button>
  <input type="checkbox" id="compareMinGames">
  <label for="compareMinGames">규정 경기 이상(14G)</label>
</div>

<div class="compare-result" id="compareResult">
  <!-- 비교 결과가 여기에 표시됩니다 -->
</div></div>
  <footer class="footer">
    © 2025 The Eroom Sports. All rights reserved.
  </footer>
</div>

<script>
const statsFormats = {
  3: {unit: '경기', decimals: 0},
  6: {unit: '분 초', decimals: 0, convert: true},
  9: {unit: '점', decimals: 0},
  10: {unit: '점', decimals: 2},
  13: {unit: '개', decimals: 0}, // FGA
  14: {unit: '개', decimals: 0}, // FG
  15: {unit: '개', decimals: 2}, // 평균 FG 시도
  16: {unit: '개', decimals: 2}, // 평균 FG 성공
  17: {unit: '%', decimals: 2}, // FG%
  21: {unit: '개', decimals: 0}, // 2PA
  22: {unit: '개', decimals: 0}, // 2P
  23: {unit: '개', decimals: 2}, // 평균 2p 시도
  24: {unit: '개', decimals: 2}, // 평균 2p 성공
  25: {unit: '%', decimals: 2}, // 2P%
  29: {unit: '개', decimals: 0}, // 3PA
  30: {unit: '개', decimals: 0}, // 3P
  31: {unit: '개', decimals: 2}, // 평균 3p 시도
  32: {unit: '개', decimals: 2}, // 평균 3p 성공
  33: {unit: '%', decimals: 2}, // 3P%
  37: {unit: '개', decimals: 0}, // FTA
  38: {unit: '개', decimals: 0}, // FT
  39: {unit: '개', decimals: 2}, // 평균 FT 시도
  40: {unit: '개', decimals: 2}, // 평균 FT 성공
  41: {unit: '%', decimals: 2}, // FT%
  45: {unit: '개', decimals: 0}, // 리바운드
  46: {unit: '개', decimals: 2}, // 평균 리바운드
  49: {unit: '개', decimals: 0}, // 공격 리바운드
  50: {unit: '개', decimals: 2}, // 평균 공격 리바운드
  53: {unit: '개', decimals: 0}, // 수비 리바운드
  54: {unit: '개', decimals: 2}, // 평균 수비 리바운드
  57: {unit: '개', decimals: 0}, // 어시스트
  58: {unit: '개', decimals: 2}, // 평균 어시스트
  61: {unit: '개', decimals: 0}, // 스틸
  62: {unit: '개', decimals: 2}, // 평균 스틸
  65: {unit: '개', decimals: 0}, // 블록
  66: {unit: '개', decimals: 2}, // 평균 블록
  69: {unit: '개', decimals: 0}, // 턴오버
  70: {unit: '개', decimals: 2}, // 평균 턴오버
  73: {unit: '개', decimals: 0}, // 파울
  74: {unit: '개', decimals: 2}, // 평균 파울
  // 여기서부터 소수점 3자리
  77: {unit: '', decimals: 3}, // WS
  78: {unit: '', decimals: 3}, // WS/40
  79: {unit: '', decimals: 3}, // Offensive WS
  80: {unit: '', decimals: 3}, // Defensive WS
  85: {unit: '', decimals: 3}, // Offensive Rating
  86: {unit: '', decimals: 3}, // Defensive Rating
  87: {unit: '', decimals: 3}, // PER
  88: {unit: '', decimals: 3}, // EFF
  89: {unit: '', decimals: 3}, // EFF/40
  95: {unit: '%', decimals: 3}, // TS%
  96: {unit: '%', decimals: 3}, // eFG%
  97: {unit: '%', decimals: 3}, // USG%
  98: {unit: '', decimals: 3}, // 3PAr
  99: {unit: '', decimals: 3}, // FTr
  105: {unit: '%', decimals: 3}, // ORB%
  106: {unit: '%', decimals: 3}, // DRB%
  107: {unit: '%', decimals: 3}, // TRB%
  108: {unit: '%', decimals: 3}, // AST%
  109: {unit: '%', decimals: 3}, // STL%
  110: {unit: '%', decimals: 3}, // BS%
  111: {unit: '%', decimals: 3} // TOV%
};
  
 const tabs = document.querySelectorAll('.tab-button');
 const contents = document.querySelectorAll('.tab-content');
 
 tabs.forEach(tab => {
   tab.onclick = () => {
     tabs.forEach(t => t.classList.remove('active'));
     contents.forEach(c => c.classList.remove('active'));
     document.getElementById(tab.dataset.tab).classList.add('active');
     tab.classList.add('active');
   };
 });
 
 let originalData = [], highlightedPlayer = '', fixedRow = null;
 
 async function loadPlayersData() {
   const res = await fetch('https://docs.google.com/spreadsheets/d/1ez03AkQt4A5HWmo3jRAV3DOyfKfCU4xiI7XCjLRjwnE/export?format=csv');
   const rows = (await res.text()).split('\n').slice(1);
   originalData = rows.map(row => row.split(',')).filter(cols => cols.length > 30);
   originalData.forEach(cols => {
     cols.push(parseInt(cols[4]) * 60 + parseInt(cols[5]));
   });
   renderTable(originalData);
 }
 
function renderTable(data) {
  const tableBody = document.getElementById('tableBody');
  tableBody.innerHTML = '';

  const minGamesOnly = document.getElementById('minGamesCheckbox').checked;
  const filteredData = minGamesOnly ? data.filter(cols => parseInt(cols[3]) >= 14) : data;

  filteredData.forEach(cols => {
    const playerName = cols[2];
    const status = cols[3] >= 14 ? '✅' : '⚠️';
    const playtime = `${cols[4]}분 ${cols[5]}초`;

    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${playerName} <span class="${cols[3] >= 20 ? 'valid' : 'warning'}">${status}</span></td>
      <td>${cols[1]}</td>
      <td>${cols[3]}</td>
<td data-time="${cols[6]}">${Math.floor(cols[6]/60)}분 ${cols[6]%60}초</td>
      <td>${cols[9]}</td>
      <td>${(+cols[10]).toFixed(2)}</td>
      <td>${cols[13]}</td>
      <td>${cols[14]}</td>
      <td>${cols[15]}</td>
      <td>${cols[16]}</td>
      <td>${cols[17]}</td>
      <td>${cols[21]}</td>
      <td>${cols[22]}</td>
      <td>${cols[23]}</td>
      <td>${cols[24]}</td>
      <td>${cols[25]}</td>
      <td>${cols[29]}</td>
      <td>${cols[30]}</td>
      <td>${cols[31]}</td>
      <td>${cols[32]}</td>
      <td>${cols[33]}</td>
      <td>${cols[37]}</td>
      <td>${cols[38]}</td>
      <td>${cols[39]}</td>
      <td>${cols[40]}</td>
      <td>${cols[41]}</td>
      <td>${cols[45]}</td>
      <td>${cols[46]}</td>
      <td>${cols[49]}</td>
      <td>${cols[50]}</td>
      <td>${cols[53]}</td>
      <td>${cols[54]}</td>
      <td>${cols[57]}</td>
      <td>${cols[58]}</td>
      <td>${cols[61]}</td>
      <td>${cols[62]}</td>
      <td>${cols[65]}</td>
      <td>${cols[66]}</td>
      <td>${cols[69]}</td>
      <td>${cols[70]}</td>
      <td>${cols[73]}</td>
      <td>${cols[74]}</td>
      <td>${cols[77]}</td>
      <td>${cols[78]}</td>
      <td>${cols[79]}</td>
      <td>${cols[80]}</td>
      <td>${cols[87]}</td>
      <td>${cols[88]}</td>
      <td>${cols[89]}</td>
      <td>${cols[85]}</td>
      <td>${cols[86]}</td>
      <td>${cols[97]}</td>
      <td>${cols[95]}</td>
      <td>${cols[96]}</td>
      <td>${cols[98]}</td>
      <td>${cols[99]}</td>
      <td>${cols[105]}</td>
      <td>${cols[106]}</td>
      <td>${cols[107]}</td>
      <td>${cols[108]}</td>
      <td>${cols[109]}</td>
      <td>${cols[110]}</td>
      <td>${cols[111]}</td>
    `;
    tableBody.appendChild(row);
  });
}
 
function searchPlayer(){
  const query = document.getElementById('searchPlayerAll').value.toLowerCase().trim();
  clearFixedRow();
  const rows = document.querySelectorAll('#tableBody tr');
  let found = false;
  rows.forEach(row => {
    const name = row.cells[0].textContent.toLowerCase();
    row.classList.remove('highlight');
    if (name.includes(query)){
      found = true;
      row.classList.add('highlight');
      fixRow(row);
    }
  });
  if (!found) alert("Player not found!");
}
 
 function fixRow(row) {
  clearFixedRow();
  fixedRow = row.cloneNode(true);
  fixedRow.classList.add('fixed-row', 'highlight');
  fixedRow.style.position = 'sticky';
  fixedRow.style.top = '34px';
  fixedRow.style.backgroundColor = '#000';
  fixedRow.style.zIndex = '500';

  const releaseBtn = document.createElement('button');
  releaseBtn.textContent = '해제';
  releaseBtn.style.marginLeft = '10px';
  releaseBtn.onclick = () => {
    clearFixedRow();
    document.getElementById('searchPlayerAll').value = "";
  };

  fixedRow.cells[0].appendChild(releaseBtn);
  document.querySelector('#statsTable thead').after(fixedRow);
}

function clearFixedRow() {
  if (fixedRow) {
    const originalRows = document.querySelectorAll('#tableBody tr');
    originalRows.forEach(row => row.classList.remove('highlight'));
    fixedRow.remove();
  }
  fixedRow = null;
}
 
 const sortDirections = {};
 document.querySelectorAll('#statsTable th').forEach((header, index) => {
   sortDirections[index] = 'asc';
   header.onclick = () => sortTable(index);
 });
 
 function sortTable(i) {
   const tableBody = document.getElementById('tableBody');
   const rows = [...tableBody.rows];
   const direction = sortDirections[i] === 'asc' ? 'desc' : 'asc';
   sortDirections[i] = direction;
 
   rows.sort((a, b) => {
     let x, y;
     if (i === 3) {
       x = parseInt(a.cells[i].getAttribute('data-time'), 10);
       y = parseInt(b.cells[i].getAttribute('data-time'), 10);
     } else {
       x = parseFloat(a.cells[i].innerText) || 0;
       y = parseFloat(b.cells[i].innerText) || 0;
     }
     return direction === 'asc' ? x - y : y - x;
   }).forEach(row => tableBody.appendChild(row));
 
   const currentSearch = document.getElementById('playerSearch').value.trim();
   if (currentSearch !== "") searchPlayer(); 
   else clearFixedRow(); 
 }
 
 window.onload = loadPlayersData;
 
 document.getElementById('minGamesCheckbox').addEventListener('change', function() {
   renderTable(originalData);
 });

  function calculateRank(filteredData, statIndex, playerValue, isHigherBetter = true) {
  const sorted = filteredData
    .map(cols => parseFloat(cols[statIndex]))
    .filter(value => !isNaN(value))
    .sort((a, b) => isHigherBetter ? b - a : a - b);

  return sorted.indexOf(parseFloat(playerValue)) + 1;
}

  function showPlayerStats() {
  const playerNameInput = document.getElementById('searchPlayer').value.trim();
  
  const minGamesChecked = document.getElementById('minGames').checked;
  let filteredData = originalData;
  if (minGamesChecked) {
    filteredData = originalData.filter(cols => parseInt(cols[3]) >= 14);
  }

  const playerData = filteredData.find(cols => 
    cols[2].trim().toLowerCase().includes(playerNameInput.toLowerCase())
  );

  if (playerData) {
    document.getElementById('playerName').innerText = playerData[2];
    document.getElementById('teamName').innerText = '(' + playerData[1] + ')';

    const statsContainer = document.getElementById('statsContainer');
    statsContainer.innerHTML = '';

    statsContainer.innerHTML += createCard('기본 정보', [
      {label: '출전 경기 수', value: playerData[3] + '경기', rank: calculateRank(filteredData, 3, playerData[3], true) + '위'},
      {label: '평균 출전 시간', value: playerData[4] + '분 ' + playerData[5] + '초', rank: calculateRank(filteredData, 4, playerData[4], true) + '위'},
      {label: '총 득점', value: playerData[9] + '점', rank: calculateRank(filteredData, 9, playerData[9], true) + '위', highlight: true},
      {label: '평균 득점', value: parseFloat(playerData[10]).toFixed(2) + '점', rank: calculateRank(filteredData, 10, playerData[10], true) + '위', highlight: true}
    ], 'primary');

    statsContainer.innerHTML += createCard('슈팅 지표', [
      {label: '평균 FG 시도', value: playerData[15], rank: calculateRank(filteredData, 15, playerData[15], true) + '위'},
      {label: '평균 FG 성공', value: playerData[16], rank: calculateRank(filteredData, 16, playerData[16], true) + '위'},
      {label: '평균 2P 시도', value: playerData[23], rank: calculateRank(filteredData, 23, playerData[23], true) + '위'},
      {label: '평균 2P 성공', value: playerData[24], rank: calculateRank(filteredData, 24, playerData[24], true) + '위'},
      {label: '평균 3P 시도', value: playerData[31], rank: calculateRank(filteredData, 31, playerData[31], true) + '위'},
      {label: '평균 3P 성공', value: playerData[32], rank: calculateRank(filteredData, 32, playerData[32], true) + '위'},
      {label: '평균 FT 시도', value: playerData[39], rank: calculateRank(filteredData, 39, playerData[39], true) + '위'},
      {label: '평균 FT 성공', value: playerData[40], rank: calculateRank(filteredData, 40, playerData[40], true) + '위'}
    ], 'primary');

    statsContainer.innerHTML += createCard('슈팅 성공률', [
      {label: 'FG%', value: playerData[17], rank: calculateRank(filteredData, 17, playerData[17], true) + '위'},
      {label: '2P%', value: playerData[25], rank: calculateRank(filteredData, 25, playerData[25], true) + '위'},
      {label: '3P%', value: playerData[33], rank: calculateRank(filteredData, 33, playerData[33], true) + '위'},
      {label: 'FT%', value: playerData[41], rank: calculateRank(filteredData, 41, playerData[41], true) + '위'}
    ], 'primary');

    statsContainer.innerHTML += createCard('리바운드 지표', [
      {label: '총 리바운드', value: playerData[45], rank: calculateRank(filteredData, 45, playerData[45], true) + '위', highlight: true},
      {label: '평균 리바운드', value: parseFloat(playerData[46]).toFixed(2), rank: calculateRank(filteredData, 46, playerData[46], true) + '위', highlight: true},
      {label: '공격 리바운드', value: playerData[49], rank: calculateRank(filteredData, 49, playerData[49], true) + '위'},
      {label: '평균 공격 리바운드', value: parseFloat(playerData[50]).toFixed(2), rank: calculateRank(filteredData, 50, playerData[50], true) + '위'},
      {label: '수비 리바운드', value: playerData[53], rank: calculateRank(filteredData, 53, playerData[53], true) + '위'},
      {label: '평균 수비 리바운드', value: parseFloat(playerData[54]).toFixed(2), rank: calculateRank(filteredData, 54, playerData[54], true) + '위'}
    ], 'primary');

    statsContainer.innerHTML += createCard('어시스트/스틸/블록 지표', [
      {label: '총 어시스트', value: playerData[57], rank: calculateRank(filteredData, 57, playerData[57], true) + '위'},
      {label: '평균 어시스트', value: parseFloat(playerData[58]).toFixed(2), rank: calculateRank(filteredData, 58, playerData[58], true) + '위'},
      {label: '총 스틸', value: playerData[61], rank: calculateRank(filteredData, 61, playerData[61], true) + '위'},
      {label: '평균 스틸', value: parseFloat(playerData[62]).toFixed(2), rank: calculateRank(filteredData, 62, playerData[62], true) + '위'},
      {label: '총 블록', value: playerData[65], rank: calculateRank(filteredData, 65, playerData[65], true) + '위'},
      {label: '평균 블록', value: parseFloat(playerData[66]).toFixed(2), rank: calculateRank(filteredData, 66, playerData[66], true) + '위'}
    ], 'primary');

    statsContainer.innerHTML += createCard('기타 지표', [
      {label: '턴오버', value: playerData[69], rank: calculateRank(filteredData, 69, playerData[69], false) + '위'},
      {label: '평균 턴오버', value: parseFloat(playerData[70]).toFixed(2), rank: calculateRank(filteredData, 70, playerData[70], false) + '위'},
      {label: '파울', value: playerData[73], rank: calculateRank(filteredData, 73, playerData[73], false) + '위'},
      {label: '평균 파울', value: parseFloat(playerData[74]).toFixed(2), rank: calculateRank(filteredData, 74, playerData[74], false) + '위'}
    ], 'primary');


statsContainer.innerHTML += createCard('WinShare 지표', [
  {label: 'WS', value: playerData[77], rank: calculateRank(filteredData, 77, playerData[77], true) + '위', highlight: true},
  {label: 'WS/40', value: playerData[78], rank: calculateRank(filteredData, 78, playerData[78], true) + '위'},
  {label: 'Offensive WS', value: playerData[79], rank: calculateRank(filteredData, 79, playerData[79], true) + '위'},
  {label: 'Defensive WS', value: playerData[80], rank: calculateRank(filteredData, 80, playerData[80], true) + '위'}
], 'secondary');



statsContainer.innerHTML += createCard('효율성 지표', [
  {label: 'PER', value: playerData[87], rank: calculateRank(filteredData, 87, playerData[87], true) + '위'},
  {label: 'EFF', value: playerData[88], rank: calculateRank(filteredData, 88, playerData[88], true) + '위'},
  {label: 'EFF/40', value: playerData[89], rank: calculateRank(filteredData, 89, playerData[89], true) + '위'},
  {label: 'Offensive Rating', value: playerData[85], rank: calculateRank(filteredData, 85, playerData[85], true) + '위'},
  {label: 'Defensive Rating', value: playerData[86], rank: calculateRank(filteredData, 86, playerData[86], false) + '위'},
  {label: 'USG%', value: playerData[97] + '%', rank: calculateRank(filteredData, 97, playerData[97], true) + '위'}
], 'secondary');



statsContainer.innerHTML += createCard('2차 슈팅 지표', [
  {label: 'TS%', value: playerData[95], rank: calculateRank(filteredData, 95, playerData[95], true) + '위'},
  {label: 'eFG%', value: playerData[96], rank: calculateRank(filteredData, 96, playerData[96], true) + '위'},
  {label: '3PAr', value: playerData[98], rank: calculateRank(filteredData, 98, playerData[98], true) + '위'},
  {label: 'FTr', value: playerData[99], rank: calculateRank(filteredData, 99, playerData[99], true) + '위'}
], 'secondary');



statsContainer.innerHTML += createCard('팀내 비중 지표', [
  {label: 'ORB%', value: playerData[105] + '%', rank: calculateRank(filteredData, 105, playerData[105], true) + '위'},
  {label: 'DRB%', value: playerData[106] + '%', rank: calculateRank(filteredData, 106, playerData[106], true) + '위'},
  {label: 'TRB%', value: playerData[107] + '%', rank: calculateRank(filteredData, 107, playerData[107], true) + '위'},
  {label: 'AST%', value: playerData[108] + '%', rank: calculateRank(filteredData, 108, playerData[108], true) + '위'},
  {label: 'STL%', value: playerData[109] + '%', rank: calculateRank(filteredData, 109, playerData[109], true) + '위'},
  {label: 'BLK%', value: playerData[110] + '%', rank: calculateRank(filteredData, 110, playerData[110], true) + '위'},
  {label: 'TOV%', value: playerData[111] + '%', rank: calculateRank(filteredData, 111, playerData[111], false) + '위'}
], 'team-stats');


  } else {
    alert('선수를 찾을 수 없습니다.');
  }
}
 document.getElementById('searchPlayerAll').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    searchPlayer();
  }
});

function createCard(title, stats, type = 'primary') {
  return `
    <div class="card ${type}">
      <h3>${title}</h3>
      <table>
        <thead>
          <tr>
            <th>지표</th>
            <th>기록</th>
            <th>순위</th>
          </tr>
        </thead>
        <tbody>
          ${stats.map(stat => `
            <tr>
              <td>${stat.label}</td>
              <td>${stat.value}</td>
              <td>${stat.rank}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}

// 전체 통계 검색창에서 엔터 키 동작
document.getElementById('searchPlayerAll').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    searchPlayer();
  }
});

// 개인 선수 탭 검색창에서 엔터 키 동작
document.getElementById('searchPlayer').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    showPlayerStats();
  }
});
// ✅ 선수 개인 검색 페이지 체크박스 이벤트 추가 (완벽해결)
document.getElementById('minGames').addEventListener('change', function() {
  const playerInput = document.getElementById('searchPlayer').value.trim();
  if (playerInput !== "") {
    showPlayerStats();  // 선수 이름 입력되어 있으면 바로 다시 검색
  }
});

// ✅ 최종 완성된 전체 지표 포함 비교 함수
function formatStatValue(idx, value) {
  const format = statsFormats[idx];
  if (!format) return value;

  let formattedValue;
  if (idx === 6 || format.unit === '분 초') {
    const totalSeconds = parseInt(value, 10);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    formattedValue = `${minutes}분 ${seconds}초`;
  } else {
    formattedValue = parseFloat(value).toFixed(format.decimals);
  }

  return formattedValue + (format.unit && format.unit !== '분 초' ? format.unit : '');
}
  function comparePlayers() {
  const player1 = document.getElementById('comparePlayer1').value.trim();
  const player2 = document.getElementById('comparePlayer2').value.trim();
  const player3 = document.getElementById('comparePlayer3').value.trim();
  const minGamesChecked = document.getElementById('compareMinGames').checked;

  // 반드시 규정 경기 적용된 데이터 사용
  let filteredData = minGamesChecked ? originalData.filter(cols => parseInt(cols[3]) >= 14) : originalData;

  const playersData = [player1, player2, player3].filter(name => name !== '').map(name =>
    filteredData.find(cols => cols[2].toLowerCase().includes(name.toLowerCase()))
  );

  if (playersData.some(data => data === undefined)) {
    alert('선수 이름을 정확히 입력해주세요.');
    return;
  }

const statsLabels = [
  {label: '출전 경기 수', idx: 3, higherBetter: true},
  {label: '평균 출전 시간(초)', idx: 6, higherBetter: true},
  {label: '득점', idx: 9, higherBetter: true},
  {label: '평균 득점', idx: 10, higherBetter: true},
  {label: 'FGA', idx: 13, higherBetter: true},
  {label: 'FG', idx: 14, higherBetter: true},
  {label: '평균 FG 시도', idx: 15, higherBetter: true},
  {label: '평균 FG 성공', idx: 16, higherBetter: true},
  {label: 'FG%', idx: 17, higherBetter: true},
  {label: '2PA', idx: 21, higherBetter: true},
  {label: '2P', idx: 22, higherBetter: true},
  {label: '평균 2P 시도', idx: 23, higherBetter: true},
  {label: '평균 2P 성공', idx: 24, higherBetter: true},
  {label: '2P%', idx: 25, higherBetter: true},
  {label: '3PA', idx: 29, higherBetter: true},
  {label: '3P', idx: 30, higherBetter: true},
  {label: '평균 3P 시도', idx: 31, higherBetter: true},
  {label: '평균 3P 성공', idx: 32, higherBetter: true},
  {label: '3P%', idx: 33, higherBetter: true},
  {label: 'FTA', idx: 37, higherBetter: true},
  {label: 'FT', idx: 38, higherBetter: true},
  {label: '평균 FT 시도', idx: 39, higherBetter: true},
  {label: '평균 FT 성공', idx: 40, higherBetter: true},
  {label: 'FT%', idx: 41, higherBetter: true},
  {label: '리바운드', idx: 45, higherBetter: true},
  {label: '평균 리바운드', idx: 46, higherBetter: true},
  {label: '공격 리바운드', idx: 49, higherBetter: true},
  {label: '평균 공격 리바운드', idx: 50, higherBetter: true},
  {label: '수비 리바운드', idx: 53, higherBetter: true},
  {label: '평균 수비 리바운드', idx: 54, higherBetter: true},
  {label: '어시스트', idx: 57, higherBetter: true},
  {label: '평균 어시스트', idx: 58, higherBetter: true},
  {label: '스틸', idx: 61, higherBetter: true},
  {label: '평균 스틸', idx: 62, higherBetter: true},
  {label: '블록', idx: 65, higherBetter: true},
  {label: '평균 블록', idx: 66, higherBetter: true},
  {label: '턴오버', idx: 69, higherBetter: false},
  {label: '평균 턴오버', idx: 70, higherBetter: false},
  {label: '파울', idx: 73, higherBetter: false},
  {label: '평균 파울', idx: 74, higherBetter: false},
  {label: 'WS', idx: 77, higherBetter: true},
  {label: 'WS/40', idx: 78, higherBetter: true},
  {label: 'Offensive WS', idx: 79, higherBetter: true},
  {label: 'Defensive WS', idx: 80, higherBetter: true},
  {label: 'Offensive Rating', idx: 85, higherBetter: true},
  {label: 'Defensive Rating', idx: 86, higherBetter: false},
  {label: 'PER', idx: 87, higherBetter: true},
  {label: 'EFF', idx: 88, higherBetter: true},
  {label: 'EFF/40', idx: 89, higherBetter: true},
  {label: 'TS%', idx: 95, higherBetter: true},
  {label: 'eFG%', idx: 96, higherBetter: true},
  {label: 'USG%', idx: 97, higherBetter: true},
  {label: '3PAr', idx: 98, higherBetter: true},
  {label: 'FTr', idx: 99, higherBetter: true},
  {label: 'ORB%', idx: 105, higherBetter: true},
  {label: 'DRB%', idx: 106, higherBetter: true},
  {label: 'TRB%', idx: 107, higherBetter: true},
  {label: 'AST%', idx: 108, higherBetter: true},
  {label: 'STL%', idx: 109, higherBetter: true},
  {label: 'BLK%', idx: 110, higherBetter: true},
  {label: 'TOV%', idx: 111, higherBetter: false}
];



  let tableHTML = `
    <table>
      <thead>
        <tr>
          <th>지표</th>
          ${playersData.map(p => `<th>${p[2]} (${p[1]})</th>`).join('')}
          ${playersData.length === 2 ? `<th>차이</th>` : ''}
        </tr>
      </thead>
      <tbody>`;

  statsLabels.forEach(stat => {
const values = playersData.map(p => {
  const value = parseFloat(p[stat.idx]);
  return isNaN(value) ? 0 : value;
});

    const ranks = values.map(val => calculateRank(filteredData, stat.idx, val, stat.higherBetter));
    const sortedValues = [...values].sort((a, b) => stat.higherBetter ? b - a : a - b);

    tableHTML += `<tr><td>${stat.label}</td>`;

const statUnits = {
  3: '경기', 6: '분 초', 9: '점', 10: '점',
  13: '개', 14: '개', 15: '개', 16: '개', 17: '%',
  21: '개', 22: '개', 23: '개', 24: '개', 25: '%',
  29: '개', 30: '개', 31: '개', 32: '개', 33: '%',
  37: '개', 38: '개', 39: '개', 40: '개', 41: '%',
  45: '개', 46: '개', 49: '개', 50: '개', 53: '개',
  54: '개', 57: '개', 58: '개', 61: '개', 62: '개',
  65: '개', 66: '개', 69: '개', 70: '개', 73: '개',
  74: '개', 77: '', 78: '', 79: '', 80: '',
  85: '', 86: '', 87: '', 88: '', 89: '',
  95: '%', 96: '%', 97: '%', 98: '', 99: '',
  105: '%', 106: '%', 107: '%', 108: '%', 109: '%',
  110: '%', 111: '%'
};

values.forEach((value, idx) => {
  const unit = statUnits[stat.idx] || '';
  const format = statsFormats[stat.idx];  // 반드시 추가

  let formattedValue;

  if (format && format.convert && format.unit === '분 초') {
    // "분 초" 변환이 필요한 경우
    const minutes = Math.floor(value / 60);
    const seconds = Math.floor(value % 60);
    formattedValue = `${minutes}분 ${seconds}초`;
  } else {
    // 다른 경우는 기존대로
    const decimalPlaces = format ? format.decimals : (unit === '%' ? 2 : Number.isInteger(value) ? 0 : 2);
    formattedValue = `${value.toFixed(decimalPlaces)}${unit}`;
  }

  let highlightClass = '';
  if (value === sortedValues[0]) highlightClass = 'highlight-first';
  else if (value === sortedValues[1]) highlightClass = 'highlight-second';
  else if (playersData.length === 3 && value === sortedValues[2]) highlightClass = 'highlight-third';

  const displayValue = `
    <span style="font-size:1.1rem; font-weight:bold;">${formattedValue}</span>
    <span style="font-size:0.8rem; color:#ddd;"> (${ranks[idx]}위)</span>
  `;

  tableHTML += `<td class="${highlightClass}">${displayValue}</td>`;
});



if (playersData.length === 2) {
  let diffDisplay, diffValue, diffClass;
  
  if (stat.idx === 6) { // 평균 출전 시간일 경우 (분 초)
    diffValue = values[0] - values[1];
    const diffSeconds = Math.abs(diffValue);
    const diffMin = Math.floor(diffSeconds / 60);
    const diffSec = diffSeconds % 60;
    diffDisplay = `${diffMin}분 ${diffSec}초`;
  } else {
    diffValue = values[0] - values[1];
const decimalPlaces = (statsFormats[stat.idx] && statsFormats[stat.idx].decimals !== undefined)
  ? statsFormats[stat.idx].decimals 
  : 2;
    diffDisplay = `${Math.abs(diffValue).toFixed(decimalPlaces)}${unit}`;
  }

  if (diffValue > 0) {
    diffClass = 'diff-positive';
  } else if (diffValue < 0) {
    diffClass = 'diff-negative';
  } else {
    diffClass = '';
  }

  tableHTML += `
    <td class="diff-cell ${diffClass}" style="color:#FFF; font-weight:bold;">
      <span style="font-size:0.75rem;">${diffDisplay}</span>
    </td>`;
}



    tableHTML += `</tr>`;
  });

  tableHTML += `</tbody></table>`;
  document.getElementById('compareResult').innerHTML = tableHTML;
}



// 엔터키 입력 기능 추가 (유지)
['comparePlayer1', 'comparePlayer2', 'comparePlayer3'].forEach(id => {
  document.getElementById(id).addEventListener('keypress', function(e) {
    if (e.key === 'Enter') comparePlayers();
  });
});

// 체크박스 즉시 반응 추가 (유지)
document.getElementById('compareMinGames').addEventListener('change', () => {
  comparePlayers();
});


  
 </script>
 
 
 </body>
 </html>
